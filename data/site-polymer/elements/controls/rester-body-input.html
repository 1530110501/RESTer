<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">

<link rel="import" href="rester-ace-input.html">
<link rel="import" href="rester-input-control-behavior.html">
<link rel="import" href="rester-url-query-input.html">

<dom-module id="rester-body-input">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
                padding-top: 8px;
            }

            #options {
                position: absolute;
                top: 8px;
                right: 0;
                z-index: 10;
                padding: 0;

                --paper-menu: {
                    width: 256px;
                };
            }

            .menu-item-divider {
                border-top: 1px solid var(--divider-color);
                margin: 4px 0;
            }

            rester-url-query-input {
                margin-right: 40px;
            }
        </style>

        <paper-menu-button id="options" horizontal-align="right" restore-focus-on-close>
            <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
            <paper-menu class="dropdown-content" selectable="paper-icon-item[role='menuitemradio']">
                <template is="dom-repeat" items="[[inputOptions]]">
                    <paper-icon-item role="menuitemradio" on-tap="_selectInputOption">
                        <iron-icon
                                icon="check"
                                item-icon
                                hidden$="[[!_isInputOptionSelected(item, selectedInputOption)]]"></iron-icon>
                        [[item.title]]
                    </paper-icon-item>
                </template>
                <div class="menu-item-divider"></div>
                <paper-icon-item role="menuitemcheckbox" on-tap="_toggleSetContentTypeHeader">
                    <iron-icon
                            icon="check"
                            item-icon
                            hidden$="[[!setContentTypeHeader]]"></iron-icon>
                    Set Content-Type header
                </paper-icon-item>
                <div class="menu-item-divider" hidden$="[[!selectedInputOption.beautifyMethod]]"></div>
                <paper-icon-item role="menuitem" hidden$="[[!selectedInputOption.beautifyMethod]]" on-tap="_beautify">
                    <iron-icon icon="editor:format-paint" item-icon></iron-icon>
                    Beautify
                </paper-icon-item>
            </paper-menu>
        </paper-menu-button>

        <template is="dom-if" if="[[selectedInputOption.isInputTypeAce]]">
            <rester-ace-input
                    mode="[[selectedInputOption.aceMode]]"
                    value="{{value}}"
                    name="[[name]]"
                    required$="[[required]]"></rester-ace-input>
        </template>

        <template is="dom-if" if="[[selectedInputOption.isInputTypeForm]]">
            <rester-url-query-input
                    value="{{value}}"
                    name="[[name]]"
                    required$="[[required]]">
            </rester-url-query-input>
        </template>
    </template>

    <script>
        Polymer({
            is: 'rester-body-input',

            behaviors: [
                RESTer.InputControlBehavior,
                Polymer.IronFormElementBehavior
            ],

            properties: {
                value: {
                    type: String,
                    notify: true,
                    value: ''
                },
                contentType: {
                    type: String,
                    notify: true,
                    observer: '_onContentTypeChanged'
                },
                inputOptions: {
                    type: Array,
                    readOnly: true,
                    value: [
                        {
                            title: 'Plain',
                            isInputTypeAce: true,
                            aceMode: 'ace/mode/text'
                        },
                        {
                            title: 'JSON',
                            isInputTypeAce: true,
                            contentType: 'application/json',
                            contentTypeSearch: 'json',
                            aceMode: 'ace/mode/json',
                            beautifyMethod: 'json'
                        },
                        {
                            title: 'XML',
                            isInputTypeAce: true,
                            contentType: 'application/xml',
                            contentTypeSearch: 'xml',
                            aceMode: 'ace/mode/xml',
                            beautifyMethod: 'xml'
                        },
                        {
                            title: 'Form',
                            isInputTypeForm: true,
                            contentType: 'application/x-www-form-urlencoded',
                            contentTypeSearch: 'x-www-form-urlencoded'
                        }
                    ]
                },
                selectedInputOption: Object,
                setContentTypeHeader: {
                    type: Boolean,
                    value: true
                }
            },

            get _focusableElement () {
                return this.$$('rester-ace-input');
            },

            ready () {
                this.selectedInputOption = this.inputOptions[0];
            },

            _onContentTypeChanged () {
                const newOption = this.inputOptions.find(o =>
                    this.contentType.toLowerCase().includes(o.contentTypeSearch));

                if (newOption) {
                    this.selectedInputOption = newOption;
                }
            },

            _isInputOptionSelected (option, selectedInputOption) {
                return selectedInputOption === option;
            },

            _selectInputOption (e) {
                this.selectedInputOption = e.model.item;
                if (this.setContentTypeHeader) {
                    this.contentType = this.selectedInputOption.contentType;
                }
            },

            _toggleSetContentTypeHeader () {
                this.setContentTypeHeader = !this.setContentTypeHeader;
            },

            _beautify () {
                this.$.options.close();
                if (this.selectedInputOption.beautifyMethod) {
                    this.value = vkbeautify[this.selectedInputOption.beautifyMethod](this.value, 4);
                }
            }
        });
    </script>
</dom-module>
