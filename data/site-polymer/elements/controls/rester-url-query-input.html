<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="rester-input-control-behavior.html">

<dom-module id="rester-url-query-input">
    <template>
        <style include="iron-flex iron-flex-alignment iron-flex-factors">
            :host {
                display: block;
            }

            .query-param-line paper-input {
                margin-right: 16px;
            }

            .query-param-line paper-icon-button {
                margin-top: 19px;
            }
        </style>

        <template is="dom-repeat" items="[[queryParams]]">
            <div class="layout horizontal start query-param-line">
                <paper-input
                        class="flex-1"
                        label="Name"
                        value="{{item.name}}"
                        on-value-changed="_onQueryParamsChanged"></paper-input>
                <paper-textarea
                        class="flex-2"
                        label="Value"
                        value="{{item.value}}"
                        on-value-changed="_onQueryParamsChanged"></paper-textarea>
                <paper-icon-button
                        icon="remove"
                        on-tap="_removeQueryParam"></paper-icon-button>
            </div>
        </template>
    </template>

    <script>
        Polymer({
            is: 'rester-url-query-input',

            behaviors: [
                RESTer.InputControlBehavior
            ],

            properties: {
                value: {
                    type: String,
                    notify: true,
                    observer: '_onValueChanged'
                },
                noEncode: {
                    type: Boolean,
                    value: false
                },
                queryParams: {
                    type: Array,
                    readOnly: true
                }
            },

            get _focusableElement () {
                return this.$$('paper-input');
            },

            _onValueChanged () {
                this._setQueryParams(this._parseQueryParams(this.value));
                this._ensureEmptyQueryParam();
            },

            _onQueryParamsChanged () {
                this.value = this._stringifyQueryParams(this.queryParams);
                this._ensureEmptyQueryParam();
            },

            _ensureEmptyQueryParam () {
                if (!this.queryParams.some(param => param.name.trim() === '' && param.value.trim() === '')) {
                    this.push('queryParams', {name: '', value: ''});
                }
            },

            _removeQueryParam (e) {
                this.splice('queryParams', e.model.index, 1);
                this._onQueryParamsChanged();
            },

            _stringifyQueryParams (params) {
                return params
                    .filter(param => param.name.trim())
                    .map(param => {
                        let str = this._encode(param.name);
                        if (param.value) {
                            str += '=' + this._encode(param.value);
                        }

                        return str;
                    })
                    .join('&');
            },

            _parseQueryParams (str) {
                return (str || '')
                    .split('&')
                    .map(row => {
                        const keyValue = row.split('=');
                        return {
                            name: this._decode(keyValue[0]),
                            value: this._decode(keyValue[1] || '')
                        };
                    })
                    .filter(row => row.name.trim());
            },

            _encode (value) {
                return this.noEncode ? value : encodeURIComponent(value);
            },

            _decode (value) {
                return this.noEncode ? value : decodeURIComponent(value);
            }
        });
    </script>
</dom-module>
