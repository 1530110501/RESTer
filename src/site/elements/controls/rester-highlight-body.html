<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="../data/rester-data.html">
<link rel="import" href="../utils/rester-error-behavior.html">
<link rel="import" href="rester-ace-input.html">
<link rel="import" href="rester-dom-purify-frame.html">

<dom-module id="rester-highlight-body">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
            }

            #options {
                position: absolute;
                top: 0;
                right: 16px; /* Make sure the scrollbar is clickable */
                z-index: 10;
                padding: 0;

                --paper-menu: {
                    width: 256px;
                };
            }

            .menu-item-divider {
                border-top: 1px solid var(--divider-color);
                margin: 4px 0;
            }

            #chooseLanguageDialog paper-radio-button {
                display: block;
            }
        </style>

        <paper-menu-button id="options" horizontal-align="right" restore-focus-on-close>
            <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
            <paper-menu class="dropdown-content" selectable="[role='menuitemradio']">
                <paper-icon-item role="menuitemcheckbox" on-tap="_toggleWrap">
                    <iron-icon icon="check" item-icon hidden$="[[!wrap]]"></iron-icon> Wrap
                </paper-icon-item>
                <paper-icon-item role="menuitemcheckbox" on-tap="_togglePrettyPrint" hidden$="[[!isPrettyPrintSupported]]">
                    <iron-icon icon="check" item-icon hidden$="[[!prettyPrint]]"></iron-icon> Pretty Print
                </paper-icon-item>
                <paper-icon-item role="menuitemcheckbox" on-tap="_toggleFullSize">
                    <iron-icon icon="check" item-icon hidden$="[[!fullSize]]"></iron-icon> Full Size
                </paper-icon-item>
                <paper-icon-item role="menuitemcheckbox" on-tap="_togglePreview" hidden$="[[!isPreviewSupported]]">
                    <iron-icon icon="check" item-icon hidden$="[[!preview]]"></iron-icon> Preview
                </paper-icon-item>
                <div class="menu-item-divider"></div>
                <paper-icon-item on-tap="_changeLanguage">
                    <iron-icon icon="language" item-icon></iron-icon> Change highlighting ([[language]])
                </paper-icon-item>
            </paper-menu>
        </paper-menu-button>

        <template is="dom-if" if="[[!preview]]">
            <rester-ace-input
                    mode="[[aceMode]]"
                    value="[[renderedBody]]"
                    use-wrap-mode="[[wrap]]"
                    read-only
                    max-lines="[[aceMaxLines]]"
                    disable-search="[[fullSize]]"></rester-ace-input>
        </template>
        <template is="dom-if" if="[[preview]]">
            <rester-dom-purify-frame html="[[body]]"></rester-dom-purify-frame>
        </template>

        <paper-dialog id="chooseLanguageDialog"
                entry-animation="scale-up-animation"
                exit-animation="fade-out-animation"
                with-backdrop
                restore-focus-on-close>
            <paper-dialog-scrollable>
                <paper-radio-group selected="{{language}}" on-paper-radio-group-changed="_closeChangeLanguageDialog">
                    <template is="dom-repeat" items="[[supportedLanguages]]">
                        <paper-radio-button name="[[item.title]]">
                            <div>[[item.title]]</div>
                        </paper-radio-button>
                    </template>
                </paper-radio-group>
            </paper-dialog-scrollable>
        </paper-dialog>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'rester-highlight-body',

                behaviors: [
                    RESTer.ErrorBehavior
                ],

                properties: {
                    body: String,
                    bodyFormatted: {
                        type: String,
                        readOnly: true
                    },
                    renderedBody: {
                        type: String,
                        computed: '_computeRenderedBody(body, bodyFormatted, prettyPrint)'
                    },
                    contentType: String,
                    language: String,
                    aceMode: {
                        type: String,
                        computed: '_computeAceMode(language)'
                    },
                    aceMaxLines: {
                        type: Number,
                        computed: '_computeAceMaxLines(fullSize)'
                    },
                    prettyPrintMode: {
                        type: String,
                        computed: '_computePrettyPrintMode(language)'
                    },
                    wrap: {
                        type: Boolean,
                        value: true
                    },
                    prettyPrint: {
                        type: Boolean,
                        value: true
                    },
                    fullSize: {
                        type: Boolean,
                        value: false
                    },
                    preview: {
                        type: Boolean,
                        value: false
                    },
                    isPrettyPrintSupported: {
                        type: Boolean,
                        computed: '_computeIsPrettyPrintSupported(prettyPrintMode)'
                    },
                    isPreviewSupported: {
                        type: Boolean,
                        computed: '_computeIsPreviewSupported(language)'
                    },
                    supportedLanguages: {
                        type: Array,
                        readOnly: true,
                        value: [
                            'Plain',
                            'HTML',
                            'JSON',
                            'XML'
                        ]
                    }
                },

                observers: [
                    '_formatBody(body, prettyPrintMode)',
                    '_autoSelectLanguage(contentType)'
                ],

                _formatBodyWorker: undefined,

                _computeRenderedBody(body, bodyFormatted, prettyPrint) {
                    if (prettyPrint && bodyFormatted) {
                        return bodyFormatted;
                    } else {
                        return body;
                    }
                },

                _computeAceMode(language) {
                    const aceModes = {
                        Plain: 'ace/mode/text',
                        HTML: 'ace/mode/html',
                        JSON: 'ace/mode/json',
                        XML: 'ace/mode/xml'
                    };

                    return aceModes[language];
                },

                _computeAceMaxLines(fullSize) {
                    return fullSize ? Infinity : 25;
                },

                _computePrettyPrintMode(language) {
                    const prettyPrintModes = {
                        JSON: 'json',
                        XML: 'xml'
                    };

                    return prettyPrintModes[language];
                },

                _computeIsPrettyPrintSupported(prettyPrintMode) {
                    return !!prettyPrintMode;
                },

                _computeIsPreviewSupported(language) {
                    return language === 'HTML';
                },

                _formatBody(body, prettyPrintMode) {
                    this._setBodyFormatted('');
                    if (this._formatBodyWorker) {
                        this._formatBodyWorker.cancel();
                        this._formatBodyWorker = undefined;
                    }

                    if (!prettyPrintMode) {
                        return;
                    }

                    this.debounce('formatBody', () => {
                        this._formatBodyWorker = RESTer.worker.FormatCode.run({
                            code: body,
                            language: prettyPrintMode
                        });

                        this._formatBodyWorker.then(result => {
                            this._formatBodyWorker = undefined;
                            this._setBodyFormatted(result);
                        });

                        this._formatBodyWorker.catch(error => {
                            this._formatBodyWorker = undefined;
                            this.showError(error);
                        });
                    }, 100);
                },

                _autoSelectLanguage(contentType) {
                    let newLanguage = this.supportedLanguages[0];
                    if (contentType) {
                        if (contentType.toLowerCase().includes('json')) {
                            newLanguage = this.supportedLanguages[2];
                        } else if (contentType.toLowerCase().includes('html')) {
                            newLanguage = this.supportedLanguages[1];
                        } else if (contentType.toLowerCase().includes('xml')) {
                            newLanguage = this.supportedLanguages[3];
                        }
                    }

                    this.language = newLanguage;
                },

                _toggleWrap() {
                    this.$.options.close();
                    this.wrap = !this.wrap;
                },

                _togglePrettyPrint() {
                    this.$.options.close();
                    this.prettyPrint = !this.prettyPrint;
                },

                _toggleFullSize() {
                    this.$.options.close();
                    this.fullSize = !this.fullSize;
                },

                _togglePreview() {
                    this.$.options.close();
                    this.preview = !this.preview;
                },

                _changeLanguage() {
                    this.$.options.close();
                    this.$.chooseLanguageDialog.open();
                },

                _closeChangeLanguageDialog() {
                    this.$.chooseLanguageDialog.close();
                }
            });
        })();
    </script>
</dom-module>
